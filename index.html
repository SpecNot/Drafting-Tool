<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Spec little dungeon</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { theme: { extend: {} } };</script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-black text-white">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useMemo, useEffect } = React;

      // ----- helpers -----
      const DND_SLOT = "application/x-spec-slot"; // custom type for slot->slot drags

      function titleFromUrl(url) {
        try {
          const u = new URL(url, window.location.href);
          const last = (u.pathname.split("/").filter(Boolean).pop() || "image");
          const base = decodeURIComponent(last).replace(/\.[^.]+$/, "");
          const pretty = base.replace(/[-_]+/g, " ").trim();
          return (pretty || "image");
        } catch {
          const clean = url.split("#")[0].split("?")[0];
          const last = (clean.split("/").pop() || "image");
          const base = decodeURIComponent(last).replace(/\.[^.]+$/, "");
          const pretty = base.replace(/[-_]+/g, " ").trim();
          return (pretty || "image");
        }
      }
      const itemsFromUrls = (urls) => urls.map((url) => ({ url, title: titleFromUrl(url) }));
      const swapUrls = (arr, a, b) => {
        const next = arr.map(s => ({ ...s }));
        const t = next[a].url; next[a].url = next[b].url; next[b].url = t;
        return next;
      };

      // ----- defaults -----
      const SLOT_COUNT = 12;
      const EXTRA_SLOT_COUNT = 10;

      const DEFAULT_IMAGES = [

      ];
      const DEFAULT_IMAGES_2 = [
        "other/boom.png",
      ];
      const DEFAULT_BG = "stages/Stage1.png";
      const BG_CHOICES = [
        "stages/Stage1.png",
        "stages/Stage2.png",
        "stages/Stage3.png",
        "stages/Stage4.png",
        "stages/Stage5.png",
      ];
      function App() {
        const [lib1, setLib1] = useState(itemsFromUrls(DEFAULT_IMAGES));
        const [lib2] = useState(itemsFromUrls(DEFAULT_IMAGES_2));
        const [activeLib, setActiveLib] = useState(1);
        const [filter, setFilter] = useState("");

        const [selectedLibUrl, setSelectedLibUrl] = useState(null);
        const [bgUrl, setBgUrl] = useState(DEFAULT_BG);

        const [slots, setSlots] = useState(() => Array.from({ length: SLOT_COUNT }, (_, i) => ({ id: i, url: null })));
        const [extraSlots, setExtraSlots] = useState(() => Array.from({ length: EXTRA_SLOT_COUNT }, (_, i) => ({ id: i, url: null })));

        // optional: load from /images1/index.json if present
        useEffect(function(){
          (async function(){
            try {
              const res = await fetch("characters/index.json", { cache: "no-store" });
              if (!res.ok) return;
              const data = await res.json();
              const names = Array.isArray(data.images) ? data.images : [];
              if (!names.length) return;
              const urls = names.map(function(name){ return "characters/" + name; });
              setLib1(itemsFromUrls(urls));
            } catch (e) {
              console.warn("Could not load index.json; using defaults.", e);
            }
          })();
        }, []);

        const currentLibrary = activeLib === 1 ? lib1 : lib2;
        const filteredLibrary = useMemo(() => {
          const term = filter.trim().toLowerCase();
          if (!term) return currentLibrary;
          return currentLibrary.filter((item) => item.title.toLowerCase().includes(term));
        }, [currentLibrary, filter]);

        const placeIntoMainSlot = (slotIndex, url) => {
          setSlots(prev => prev.map((s,i) => i === slotIndex ? { ...s, url } : s));
        };
        const clearMainSlot = (slotIndex) => {
          setSlots(prev => prev.map((s,i) => i === slotIndex ? { ...s, url: null } : s));
        };
        const placeIntoExtraSlot = (slotIndex, url) => {
          setExtraSlots(prev => prev.map((s,i) => i === slotIndex ? { ...s, url } : s));
        };
        const clearExtraSlot = (slotIndex) => {
          setExtraSlots(prev => prev.map((s,i) => i === slotIndex ? { ...s, url: null } : s));
        };

        // --- Drag/drop handlers: slotâ†’slot (swap/move) + library URL drop ---
        const onDropToMain = (e, destIndex) => {
          e.preventDefault();
          const payloadStr = e.dataTransfer.getData(DND_SLOT);
          if (payloadStr) {
            try {
              const p = JSON.parse(payloadStr);
              if (p && p.area === "main") {
                setSlots(prev => swapUrls(prev, p.index, destIndex));
                return;
              }
              if (p && p.area === "extra") {
                const srcUrl = extraSlots[p.index]?.url || null;
                setSlots(prev => prev.map((s,i)=> i===destIndex ? { ...s, url: srcUrl } : s));
                setExtraSlots(prev => prev.map((s,i)=> i===p.index ? { ...s, url: null } : s));
                return;
              }
            } catch {}
          }
          const url = e.dataTransfer.getData("text/uri-list") || e.dataTransfer.getData("text/plain");
          if (url) placeIntoMainSlot(destIndex, url);
        };

        const onDropToExtra = (e, destIndex) => {
          e.preventDefault();
          const payloadStr = e.dataTransfer.getData(DND_SLOT);
          if (payloadStr) {
            try {
              const p = JSON.parse(payloadStr);
              if (p && p.area === "extra") {
                setExtraSlots(prev => swapUrls(prev, p.index, destIndex));
                return;
              }
              if (p && p.area === "main") {
                const srcUrl = slots[p.index]?.url || null;
                setExtraSlots(prev => prev.map((s,i)=> i===destIndex ? { ...s, url: srcUrl } : s));
                setSlots(prev => prev.map((s,i)=> i===p.index ? { ...s, url: null } : s));
                return;
              }
            } catch {}
          }
          const url = e.dataTransfer.getData("text/uri-list") || e.dataTransfer.getData("text/plain");
          if (url) placeIntoExtraSlot(destIndex, url);
        };

        const selectedCount = useMemo(() => slots.filter(s => !!s.url).length, [slots]);

        return (
          <div className="min-h-screen w-full bg-black text-white">
            <header className="sticky top-0 z-10 bg-white/10 backdrop-blur border-b border-white/10">
              <div className="w-full py-3 flex items-center justify-between px-4">
                <div className="flex items-center gap-3">
                  <div className="size-8 rounded-xl bg-black/90 flex items-center justify-center text-white font-bold">spec</div>
                  <div>
                    <h1 className="text-lg font-semibold leading-tight">S&B Drafting tool</h1>
                    <p className="text-xs text-white/60">click to clear, drag and drop, yali yada</p>
                  </div>
                </div>
                <div className="flex items-center gap-2">
                  <button onClick={() => { setSlots(prev => prev.map(s => ({...s, url: null}))); setExtraSlots(prev => prev.map(s => ({...s, url: null}))); }} className="px-3 py-2 rounded-xl bg-white/10 text-white text-sm hover:bg-white/20">Clear All Slots</button>
                </div>
              </div>
            </header>

            <section className="w-full py-3 flex items-start gap-6">
              <div className="flex flex-col">
                <div className="relative w-[1200px] h-[660px] rounded-2xl overflow-hidden border border-white/20 bg-black"
                     style={{ backgroundImage: "url(" + bgUrl + ")", backgroundSize: "cover", backgroundPosition: "center" }}>
                  {/* main grid (300x400) */}
                  <div className="absolute left-6 top-1/2 -translate-y-1/2">
                    <div className="grid grid-cols-3 grid-rows-4 w-[300px] h-[400px] gap-0 bg-white/10 backdrop-blur-[1px] rounded-xl overflow-hidden">
                      {slots.map((slot, i) => (
                        <div key={slot.id}
                             className="relative w-full h-full border border-white/30"
                             onDragEnter={(e) => e.currentTarget.classList.add("ring-2","ring-white/60")}
                             onDragLeave={(e) => e.currentTarget.classList.remove("ring-2","ring-white/60")}
                             onDrop={(e) => e.currentTarget.classList.remove("ring-2","ring-white/60")}>
                          <div
                            className="absolute inset-0"
                            onClick={() => { if (selectedLibUrl) { placeIntoMainSlot(i, selectedLibUrl); } else if (slot.url) { clearMainSlot(i); } }}
                            onDragOver={(e) => { e.preventDefault(); e.dataTransfer.dropEffect = e.dataTransfer.types.includes(DND_SLOT) ? "move" : "copy"; }}
                            onDrop={(e) => onDropToMain(e, i)}
                            draggable={!!slot.url}
                            onDragStart={(e) => {
                              if (!slot.url) return;
                              e.dataTransfer.setData(DND_SLOT, JSON.stringify({ area: "main", index: i }));
                              e.dataTransfer.effectAllowed = "move";
                            }}
                          >
                            {slot.url
                              ? <img src={slot.url} alt={"Slot " + (i+1)} className="h-full w-full object-cover" draggable={false} />
                              : <div className="flex h-full w-full items-center justify-center text-[10px] text-white/80 select-none">click or drop</div>
                            }
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>

                  {/* background choices - right side in one column */}
                  <div className="absolute right-4 top-1/2 -translate-y-1/2">
                    <div className="grid grid-cols-1 gap-2">
                      {BG_CHOICES.map((url, idx) => (
                        <button key={idx}
                                onClick={() => setBgUrl(url)}
                                className={"relative h-20 w-28 rounded-lg border " + (bgUrl === url ? "border-red-600 ring-2 ring-red-600" : "border-white/30 hover:border-white/50")}
                                style={{ backgroundImage: "url(" + url + ")", backgroundSize: "cover", backgroundPosition: "center" }}
                                title={"img " + (idx + 1)}>
                          <span className="absolute inset-x-0 bottom-0 text-[11px] px-2 py-1 bg-black/50 text-white">{"Stage " + (idx + 1)}</span>
                        </button>
                      ))}
                    </div>
                  </div>
                </div>

                {/* extra placements row (drag-enabled, click-to-clear) */}
                <div className="mt-2 flex gap-2 flex-nowrap">
                  {extraSlots.map((slot, i) => (
                    <div key={slot.id}
                         className="relative w-[96px] h-[96px] rounded-xl overflow-hidden border border-white/30 bg-transparent shrink-0"
                         onClick={() => { if (selectedLibUrl) placeIntoExtraSlot(i, selectedLibUrl); else if (slot.url) clearExtraSlot(i); }}
                         onDragOver={(e) => { e.preventDefault(); e.dataTransfer.dropEffect = e.dataTransfer.types.includes(DND_SLOT) ? "move" : "copy"; }}
                         onDrop={(e) => onDropToExtra(e, i)}
                         onDragEnter={(e) => e.currentTarget.classList.add("ring-2","ring-white/60")}
                         onDragLeave={(e) => e.currentTarget.classList.remove("ring-2","ring-white/60")}
                    >
                      {slot.url
                        ? <img src={slot.url} alt={"Extra " + (i+1)} className="h-full w-full object-cover" draggable={false} />
                        : <div className="absolute inset-0 flex items-center justify-center text-[10px] text-white/80 select-none">click or drop</div>
                      }
                      {/* Make the whole tile draggable if it has content */}
                      <div
                        className="absolute inset-0"
                        draggable={!!slot.url}
                        onDragStart={(e) => {
                          if (!slot.url) return;
                          e.dataTransfer.setData(DND_SLOT, JSON.stringify({ area: "extra", index: i }));
                          e.dataTransfer.effectAllowed = "move";
                        }}
                      />
                    </div>
                  ))}
                </div>
              </div>

              {/* image library */}
              <aside className="w-[650px] shrink-0 pr-4">
                <div className="mb-3 flex flex-wrap items-center gap-2">
                  <div className="inline-flex rounded-xl border border-white/30 overflow-hidden">
                    <button className={"px-3 py-1.5 text-sm " + (activeLib === 1 ? "bg-white/10 text-white" : "bg-transparent text-white hover:bg-white/10")}
                            onClick={() => setActiveLib(1)}>Characters</button>
                    <button className={"px-3 py-1.5 text-sm " + (activeLib === 2 ? "bg-white/10 text-white" : "bg-transparent text-white hover:bg-white/10")}
                            onClick={() => setActiveLib(2)}>Others</button>
                  </div>
                  <div className="relative">
                    <input value={filter}
                           onChange={(e) => setFilter(e.target.value)}
                           placeholder="Filter by name..."
                           className="px-3 py-1.5 rounded-xl border border-white/30 bg-black/40 text-white placeholder-white/60 text-sm focus:outline-none focus:ring-2 focus:ring-white/30" />
                  </div>
                </div>

                <div className="grid grid-cols-4 gap-2 max-h-[700px] overflow-auto pr-1">
                  {filteredLibrary.map((item, idx) => (
                    <button key={item.url + idx}
                            className={"relative aspect-square rounded-md overflow-hidden border " + (selectedLibUrl === item.url ? "border-red-600 ring-2 ring-red-600" : "border-white/30 hover:border-white/50")}
                            onClick={() => setSelectedLibUrl((prev) => (prev === item.url ? null : item.url))}
                            draggable
                            onDragStart={(e) => { e.dataTransfer.setData("text/uri-list", item.url); e.dataTransfer.setData("text/plain", item.url); }}
                            title={item.title}>
                      <img src={item.url} alt={item.title} className="h-full w-full object-cover" />
                      <div className="absolute left-0 right-0 bottom-0 text-[8px] px-1 py-[2px] bg-black/50 text-white line-clamp-1 text-left">{item.title}</div>
                      {selectedLibUrl === item.url ? <div className="absolute inset-0 ring-4 ring-inset ring-red-300 pointer-events-none" /> : null}
                    </button>
                  ))}
                  {filteredLibrary.length === 0 ? <div className="col-span-full text-xs text-white/70">No images match "{filter}".</div> : null}
                </div>
              </aside>
            </section>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
